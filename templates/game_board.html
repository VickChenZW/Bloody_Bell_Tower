<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆè¿›è¡Œä¸­ - è¡€æŸ“é’Ÿæ¥¼åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; }
        
        /* ç©å®¶åœ†ç›˜ */
        /* å…³é”®ä¿®å¤ 1: è®©å®¹å™¨å»é€‚åº”å¤–éƒ¨å¸ƒå±€ï¼Œè€Œä¸æ˜¯è¢«å†…éƒ¨å…ƒç´ æ’‘å¼€ */
        #player-circle-container {
            width: 100%; /* å®½åº¦å æ»¡çˆ¶å…ƒç´  (<section>) */
            max-width: 500px; /* æœ€å¤§å®½åº¦ä¸è¶…è¿‡500pxï¼Œé˜²æ­¢åœ¨å¤§å±å¹•ä¸Šè¿‡å¤§ */
            margin: 2rem auto; /* æ°´å¹³å±…ä¸­ */
            aspect-ratio: 1 / 1; /* ä¿è¯å®¹å™¨æœ¬èº«æ˜¯æ­£æ–¹å½¢ï¼Œå®½é«˜æ¯”ä¸º1:1 */
            position: relative; /* ä½œä¸ºå†…éƒ¨ç»å¯¹å®šä½å…ƒç´ çš„åŸºå‡† */
        }

        /* å…³é”®ä¿®å¤ 2: è®©åœ†ç›˜å®Œå…¨å¡«å……è‡ªé€‚åº”çš„å®¹å™¨ */
        #player-circle { 
            position: relative; 
            width: 100%; 
            height: 100%; 
        }
        
        /* è¯´ä¹¦äººç©å®¶å¤´åƒ */
        .player-node {
            position: absolute; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center;
            transition: all 0.3s ease; 
            cursor: pointer; 
            text-align: center;
            transform: translate(-50%, -50%);
        }

        .player-node.dead, .player-node.executed { filter: grayscale(1); opacity: 0.7; }
        .player-node.final_vote { border-color: #a855f7; }

        .status-icon, .effect-icons span, .vote-emoji { 
            display: none; 
        }
        .player-node.dead .status-icon, .player-node.executed .status-icon, .player-node.final_vote .status-icon { 
            display: inline-block; 
        }
        .player-node.is_imp .imp-icon, 
        .player-node.poisoned .effect-poison, 
        .player-node.drunk .effect-drunk,
        .player-node.is_drunkard .effect-is_drunkard, 
        .player-node.is_recluse .effect-is_recluse, 
        .player-node.is_protected .effect-is_protected { 
            display: inline;
        }

        @media (max-width: 640px) {
            #player-circle {
                width: 95vw;
                height: 95vw;
                margin: 1rem auto;
            }
        }

        .action-completed { color: #6b7280; }
        .action-completed::after { content: 'âœ…'; margin-left: 8px; }
        .role-help-icon { cursor: pointer; font-weight: bold; color: #93c5fd; margin-left: 4px; }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- ä¸»å®¹å™¨ -->
    <div class="container mx-auto p-2 sm:p-4 max-w-7xl">
        <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
        <header class="bg-gray-800 p-4 rounded-xl mb-4 flex flex-col sm:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-indigo-400">è¡€æŸ“é’Ÿæ¥¼åŠ©æ‰‹</h1>
                <p class="text-gray-300">å½“å‰ç”¨æˆ·: <span id="current-user" class="font-semibold">{{ session.username }}</span> (<span id="current-role">{{ session.role }}</span> - <span id="current-number">{{ session.number }}</span>å·)</p>
            </div>
            <div class="flex flex-row gap-2">
                 <a href="/logout" class="bg-red-600 hover:bg-red-700 text-white font-bold text-sm sm:text-base py-2 px-4 rounded-lg transition">é€€å‡ºç™»å½•</a>
                 {% if session.is_storyteller %}
                 <a href="/reset_game" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold text-sm sm:text-base py-2 px-4 rounded-lg transition" onclick="return confirm('ç¡®å®šè¦é‡ç½®æ¸¸æˆå—ï¼Ÿæ‰€æœ‰è¿›åº¦å°†ä¸¢å¤±ï¼')">é‡ç½®æ¸¸æˆ</a>
                 {% endif %}
            </div>
        </header>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="flex flex-col gap-5">

            <!-- ä¿¡æ¯é¢æ¿ (ä¼˜åŒ–å¸ƒå±€é¡ºåº) -->
            <aside class="bg-gray-800 p-4 sm:p-6 rounded-xl w-full">
                {% if session.is_storyteller %}
                <!-- ########## è¯´ä¹¦äººæ§åˆ¶é¢æ¿ ########## -->
                <div id="storyteller-controls">
                    <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">è¯´ä¹¦äººæ§åˆ¶å°</h2>
                    <div class="space-y-4">
                        <div id="st-game-setup-info" class="hidden">
                             <h3 class="font-semibold text-lg mb-2">æ¸¸æˆå‡†å¤‡ä¸­</h3>
                             <p class="text-gray-400">ç©å®¶åŠ å…¥æƒ…å†µ: <span id="player-join-status" class="font-bold text-xl text-yellow-400">0/0</span></p>
                             <button id="start-game-btn" class="w-full mt-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>å¼€å§‹æ¸¸æˆ</button>
                        </div>
                        <div id="st-game-progress-info" class="hidden">
                            <h3 class="font-semibold text-lg mb-2">æ¸¸æˆé˜¶æ®µ</h3>
                            <p class="text-gray-400">å½“å‰: <span id="game-phase-display" class="font-bold text-xl">æœªå¼€å§‹</span> <span id="night-number-display" class="text-sm"></span></p>
                            <button id="change-phase-btn" class="w-full mt-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">å¼€å§‹å¤œæ™š</button>
                        </div>
                        <div id="day-actions" class="hidden">
                            <h3 class="font-semibold text-lg mb-2">ç™½å¤©è¡ŒåŠ¨</h3>
                            <p class="text-gray-400 text-sm">ç‚¹å‡»ç©å®¶å¸­ä½ä¸Šçš„ç©å®¶ï¼Œå¯ä»¥å‘èµ·å¤„å†³æŠ•ç¥¨ã€‚</p>
                             <!-- æŠ•ç¥¨çŠ¶æ€æŒ‰é’® -->
                            <button id="st-vote-status-btn" class="w-full mt-2 bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg hidden"></button>
                             <!-- <div id="vote-results-area" class="hidden bg-gray-700 p-4 rounded-lg mt-2">
                                 <h4 class="font-semibold text-yellow-300 mb-2">å½“å‰æŠ•ç¥¨ç»“æœ</h4>
                                 <div id="vote-tally"></div> -->
                             <!-- </div> -->
                        </div>
                        <div id="night-actions">
                            <h3 class="font-semibold text-lg mb-2">å¤œæ™šè¡ŒåŠ¨é¡ºåº</h3>
                            <ul id="night-action-list" class="space-y-2"></ul>
                        </div>
                        <div id="st-dynamic-action-area" class="bg-gray-700 p-4 rounded-lg hidden">
                            <h3 id="st-action-title" class="font-semibold text-lg mb-3 text-yellow-300"></h3>
                            <div id="st-action-controls" class="space-y-3"></div>
                            <button id="st-action-submit-btn" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 font-bold py-2 px-4 rounded-lg">å‘é€ä¿¡æ¯</button>
                        </div>
                    </div>
                </div>
                {% else %}
                <!-- ########## ç©å®¶ä¿¡æ¯é¢æ¿ ########## -->
                <div id="player-info">
                    <div id="player-waiting-area">
                        <h2 class="text-xl font-bold mb-4 text-yellow-400">ç­‰å¾…æ¸¸æˆå¼€å§‹...</h2>
                        <p class="text-gray-300">è¯´ä¹¦äººæ­£åœ¨é…ç½®æ¸¸æˆï¼Œè¯·ç¨å€™ã€‚å½“æ‰€æœ‰ç©å®¶åŠ å…¥åï¼Œè¯´ä¹¦äººå°†å¼€å§‹æ¸¸æˆå¹¶åˆ†é…è§’è‰²ã€‚</p>
                    </div>
                    <div id="player-game-area" class="hidden">
                        <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">æˆ‘çš„çŠ¶æ€</h2>
                        <div id="self-info-card" class="bg-gray-700 p-4 rounded-lg"></div>
                        <div class="mt-4 bg-gray-700 p-4 rounded-lg">
                            <h3 class="font-semibold text-lg">æ¸¸æˆé˜¶æ®µ</h3>
                            <p class="text-gray-400">å½“å‰: <span id="player-game-phase-display" class="font-bold text-xl"></span> <span id="player-night-number-display" class="text-sm"></span></p>
                        </div>
                        <div id="player-action-area" class="mt-4 hidden">
                             <h3 class="font-semibold text-lg mb-2">ä½ çš„è¡ŒåŠ¨</h3>
                             <div id="action-controls" class="bg-gray-700 p-4 rounded-lg space-y-3">
                                <p id="action-prompt" class="text-yellow-300"></p>
                                <div id="storyteller-info-box" class="text-cyan-300 bg-gray-600 p-3 rounded-md hidden"></div>
                                <div id="player-choice-controls" class="space-y-2"></div>
                                <button id="submit-action-btn" class="w-full bg-green-600 hover:bg-green-700 font-bold py-2 px-4 rounded-lg">ç¡®è®¤è¡ŒåŠ¨</button>
                             </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </aside>

            <!-- ä¸­é—´é¢æ¿ -->
            <section class="bg-gray-800 p-4 sm:p-6 rounded-xl w-full">
                <h2 class="text-xl font-bold mb-4 text-center">
                    {% if session.is_storyteller %}ç©å®¶å¸­ä½{% else %}æ‰€æœ‰ç©å®¶{% endif %}
                </h2>
                {% if session.is_storyteller %}
                <div id="player-circle-container">
                    <div id="player-circle"></div>
                </div>
                {% else %}
                <div id="player-list" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2 sm:gap-4"></div>
                {% endif %}
            </section>

            <!-- åº•éƒ¨æ—¥å¿—é¢æ¿ -->
            <div class="bg-gray-800 p-4 sm:p-6 rounded-xl w-full">
                <h2 class="text-xl font-bold mb-4">æ¸¸æˆæ—¥å¿—</h2>
                <div id="log-box" class="h-48 bg-gray-900 rounded-lg p-4 overflow-y-auto flex flex-col-reverse"></div>
            </div>
            <!-- æ‰€æœ‰è§’è‰²ç©æ³•è¯´æ˜ -->
            <div class="bg-gray-800 p-4 sm:p-6 rounded-xl w-full">
                <h2 clas="test-xl font-bold md-4">æ¸¸æˆä»‹ç»</h2>
                <div class=" flex flex-row gap-2">  
                    <button id="help_btn" onclick="getHelp()" class="w-full mt-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">æ˜¾ç¤ºç©å®¶ä½¿ç”¨è¯´æ˜</button>
                    <select id="help_select" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none">test</select>
                </div>
            </div>
        </main>
    </div>

    <!-- ç©å®¶æ“ä½œæ¨¡æ€æ¡† (è¯´ä¹¦äººç”¨) -->
    <div id="player-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4" id="modal-title"></h3>
            <div class="space-y-3">
                <button id="modal-initiate-vote-btn" class="w-full bg-cyan-600 hover:bg-cyan-700 font-bold py-2 px-4 rounded-lg hidden">å‘èµ·å¤„å†³æŠ•ç¥¨</button>
                <hr id="vote-hr" class="border-gray-600 hidden">
                <button id="modal-kill-btn" class="w-full bg-red-600 hover:bg-red-700 font-bold py-2 px-4 rounded-lg">æ ‡è®°ä¸ºã€æ­»äº¡ã€‘</button>
                <button id="modal-final-vote-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 font-bold py-2 px-4 rounded-lg">æ ‡è®°ä¸ºã€ä»…å‰©ä¸€ç¥¨ã€‘</button>
                <!-- <button id="modal-execute-btn" class="w-full bg-orange-500 hover:bg-orange-600 font-bold py-2 px-4 rounded-lg">æ ‡è®°ä¸ºã€å¤„å†³ã€‘(åå°çŠ¶æ€)</button> -->
                <button id="modal-revive-btn" class="w-full bg-green-600 hover:bg-green-700 font-bold py-2 px-4 rounded-lg">æ ‡è®°ä¸ºã€å­˜æ´»ã€‘</button>
                <hr class="border-gray-600">
                <button id="modal-set-imp-btn" class="w-full bg-rose-600 hover:bg-rose-700 font-bold py-2 px-4 rounded-lg">è®¾ä¸ºã€å°æ¶é­”ã€‘</button>
                <hr class="border-gray-600">
                <button id="modal-poison-btn" class="w-full bg-purple-600 hover:bg-purple-700 font-bold py-2 px-4 rounded-lg">åˆ‡æ¢ã€ä¸­æ¯’ã€‘æ•ˆæœ</button>
                <!-- <button id="modal-drunk-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-4 rounded-lg">åˆ‡æ¢ã€é†‰é…’ã€‘æ•ˆæœ</button> -->
                <button id="modal-is-drunkard-btn" class="w-full bg-yellow-700 hover:bg-yellow-800 font-bold py-2 px-4 rounded-lg">åˆ‡æ¢ã€é…’é¬¼ã€‘èº«ä»½</button>
                <button id="modal-is-recluse-btn" class="w-full bg-gray-500 hover:bg-gray-600 font-bold py-2 px-4 rounded-lg">åˆ‡æ¢ã€å‡æ¶é­”ã€‘èº«ä»½</button>
                <button id="modal-is-protected-btn" class="w-full bg-blue-500 hover:bg-blue-600 font-bold py-2 px-4 rounded-lg">åˆ‡æ¢ã€å®ˆæŠ¤ã€‘çŠ¶æ€</button>
            </div>
            <button onclick="closeModal()" class="w-full mt-6 bg-gray-600 hover:bg-gray-700 font-bold py-2 px-4 rounded-lg">å…³é—­</button>
        </div>
    </div>
    
    <!-- å…¨å±æ¶ˆæ¯æç¤ºæ¡† -->
    <div id="system-message-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-8 w-full max-w-md text-center shadow-2xl border border-gray-700">
            <h3 class="text-2xl font-bold text-yellow-300 mb-4">ç³»ç»Ÿæç¤º</h3>
            <p id="system-message-content" class="text-white text-lg mb-6 whitespace-pre-wrap"></p>
            <button id="system-message-close-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg">å¥½çš„</button>
        </div>
    </div>

    <!-- æŠ•ç¥¨é€‰æ‹©æ¶ˆæ¯æ¡† -->
    <div id="select-message-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-8 w-full max-w-md text-center shadow-2xl border border-gray-700">
            <h3 class="text-2xl font-bold text-yellow-300 mb-4">å¤„å†³æŠ•ç¥¨</h3>
            <p id="select-message-content" class="text-white text-lg mb-6 whitespace-pre-wrap"></p>
            <div class="flex justify-center gap-4">
                <button id="select-message-ok-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg text-2xl">ğŸ‘</button>
                <button id="select-message-refuse-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg text-2xl">ğŸ‘</button>
                <button id="select-message-null-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg text-2xl">ğŸ¤·</button>
            </div>
        </div>
    </div>

    <!-- å…³é”®ä¿®æ”¹ï¼šé€šè¿‡ script æ ‡ç­¾ä¼ é€’åç«¯å˜é‡ç»™ JS æ–‡ä»¶ -->
    <script>
        const IS_STORYTELLER = {{ 'true' if session.is_storyteller else 'false' }};
        const CURRENT_USERNAME = "{{ session.username }}";
        const GAME_MODE = "{{ session.game_mode }}";
    </script>
    <!-- å¼•å…¥å¤–éƒ¨ JS æ–‡ä»¶ï¼Œä½¿ç”¨ defer ç¡®ä¿åœ¨ HTML è§£æåæ‰§è¡Œ -->
    <script src="{{ url_for('static', filename='js/game_board.js') }}" defer></script>
</body>
</html>
