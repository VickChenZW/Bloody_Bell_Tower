<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置新游戏 - 血染钟楼助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .role-card { transition: all 0.2s ease-in-out; }
        .role-card.selected {
            border-color: #4f46e5;
            background-color: #3730a3;
            transform: scale(1.05);
        }
        .tooltip {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .has-tooltip:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-900 text-white pb-48">
    <div class="container mx-auto p-4 sm:p-8 max-w-4xl">
        <h1 class="text-3xl font-bold text-center text-indigo-400 mb-8">配置新游戏 (随机分配模式)</h1>

        <form action="/setup_game" method="POST">
            <!-- 步骤一：设置玩家人数 -->
            <div class="bg-gray-800 p-6 rounded-xl mb-8">
                <label for="player_count" class="block text-xl font-medium text-gray-200 mb-3">1. 设置总玩家人数</label>
                <input type="number" id="player_count" name="player_count" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-3 text-lg" placeholder="例如：10" required min="2">
            </div>

            <!-- 步骤二：选择角色 -->
            <div class="bg-gray-800 p-6 rounded-xl mb-8">
                <h2 class="text-xl font-medium text-gray-200 mb-4">2. 选择本局游戏的角色</h2>
                <div id="role-selection-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                    <!-- {% for role, desc in role_descriptions.items() %}
                    <div class="role-card border-2 border-gray-700 bg-gray-700 p-3 rounded-lg cursor-pointer has-tooltip relative" onclick="toggleRole(this, '{{ role_types[role] }}')">
                        <input type="checkbox" name="roles" value="{{ role }}" class="hidden">
                        <h4 class="font-bold text-center">{{ role }}</h4>
                        <div class="tooltip absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-64 bg-gray-900 text-white text-xs rounded-lg py-2 px-3 z-10 border border-indigo-500">
                            <p class="font-bold mb-1">{{ role }}</p>
                            <p>{{ desc }}</p>
                        </div>
                    </div>
                    {% endfor %} -->
                    <!-- 使用js动态生成 -->
                </div>
            </div>

            <!-- 步骤三：确认并开始 -->
            <div class="bg-gray-800 p-6 fixed bottom-0 left-0 right-0 z-20 shadow-2xl shadow-slate-600 border border-gray-700">
                <h3 class="text-xl font-medium text-gray-200 mb-4">3. 确认配置</h3>
                <div class="flex flex-wrap gap-4 justify-between items-center mb-4">
                    <div>
                        <p>已选角色数量: <span id="selected-count" class="font-bold text-2xl text-yellow-400">0</span></p>
                        <p>需要选择数量: <span id="required-count" class="font-bold text-2xl text-indigo-400">0</span></p>
                    </div>
                    <div class="text-right">
                        <p>善良: <span id="good-count" class="font-bold text-green-400">0</span></p>
                        <p>邪恶: <span id="evil-count" class="font-bold text-red-400">0</span></p>
                    </div>
                </div>
                <button id="submit-btn" type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>
                    创建游戏
                </button>
                <p id="error-message" class="text-center text-red-500 mt-2 font-semibold"></p>
            </div>
        </form>
    </div>

    <script>
        const ROLE_DESCRIPTIONS = {{role_descriptions | tojson}};
        const ROLE_TYPES = {{role_types | tojson}};
        const ROLES_IN_ORDER = [
            '洗衣妇', '图书管理员', '调查员', '厨师', '共情者', '占卜师', '送葬者', '僧侣', '守鸦人', '贞洁者',
            '猎手', '士兵', '镇长', '管家', '陌客', '酒鬼', '圣徒', '投毒者', '红唇女郎', '间谍', '男爵', '小恶魔'
        ];
    </script>
    <script>
        const playerCountInput = document.getElementById('player_count');
        const selectedCountSpan = document.getElementById('selected-count');
        const roleGrid = document.getElementById("role-selection-grid")
        const requiredCountSpan = document.getElementById('required-count');
        const goodCountSpan = document.getElementById('good-count');
        const evilCountSpan = document.getElementById('evil-count');
        const submitBtn = document.getElementById('submit-btn');
        const errorMessage = document.getElementById('error-message');

        let selectedRoles = new Set();
        let goodCount = 0;
        let evilCount = 0;

        function populateRoleGrid() {
            roleGrid.innerHTML = ''; // 清空现有内容
            ROLES_IN_ORDER.forEach(role => {
                
                const desc = ROLE_DESCRIPTIONS[role];
                if (!desc) return;
                
                
                const roleType = ROLE_TYPES[role] || 'good'; // 默认为善良
                let borderColor = roleType === 'evil' ? 'border-red-900':'border-gray-700';

                const card = document.createElement('div');
                card.className = `role-card border-2 ${borderColor} bg-gray-800 p-3 rounded-lg cursor-pointer has-tooltip relative`;
                card.onclick = () => toggleRole(card, roleType);

                card.innerHTML = `
                    <input type="checkbox" name="roles" value="${role}" class="hidden">  
                    </style>
                    <h4 class="font-bold text-center" >${role}</h4>
                    <h5 class=" text-gray-400 text-xs">${desc}</h5>
                    </div>
                `;
                roleGrid.appendChild(card);
            });
        }
        
        function toggleRole(element, type) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            const role = checkbox.value;

            if (selectedRoles.has(role)) {
                selectedRoles.delete(role);
                checkbox.checked = false;
                element.classList.remove('selected');
                if (type === 'good') goodCount--;
                if (type === 'evil') evilCount--;
            } else {
                selectedRoles.add(role);
                checkbox.checked = true;
                element.classList.add('selected');
                if (type === 'good') goodCount++;
                if (type === 'evil') evilCount++;
            }
            updateCounts();
        }

        function updateCounts() {
            const playerCount = parseInt(playerCountInput.value) || 0;
            selectedCountSpan.textContent = selectedRoles.size;
            requiredCountSpan.textContent = playerCount;
            goodCountSpan.textContent = goodCount;
            evilCountSpan.textContent = evilCount;
            
            if (playerCount > 0 && selectedRoles.size === playerCount) {
                submitBtn.disabled = false;
                submitBtn.textContent = '创建游戏';
                errorMessage.textContent = '';
            } else {
                submitBtn.disabled = true;
                if (playerCount === 0) {
                    submitBtn.textContent = '请先输入玩家人数';
                } else if (selectedRoles.size > playerCount) {
                    submitBtn.textContent = '选择的角色过多';
                    errorMessage.textContent = `请移除 ${selectedRoles.size - playerCount} 个角色。`;
                } else {
                    submitBtn.textContent = '创建游戏';
                    errorMessage.textContent = `还需选择 ${playerCount - selectedRoles.size} 个角色。`;
                }
            }
        }

        playerCountInput.addEventListener('input', updateCounts);
        populateRoleGrid();
        updateCounts(); // Initial call
    </script>
</body>
</html>
